<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>ë°˜ì„ì´ë„¤ ê°€ì¡± ì—¬í–‰ ë¯¸ì…˜</title>

<!-- iOS ì›¹ì•± ëŠë‚Œ ìœ ì§€ -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="ê°€ì¡± ì—¬í–‰" />
<meta name="theme-color" content="#ff6aa3" />

<style>
  :root{
    --bg-grad: linear-gradient(135deg, #ff8ab5, #ff6aa3 40%, #a02ede);
    --accent-grad: linear-gradient(90deg, #ff6aa3, #ffb0d4);   /* ì§„í–‰ë¥ /í¬ì¸íŠ¸ */
    --btn-grad: linear-gradient(90deg, #ff6aa3, #ff2d6f);      /* ë²„íŠ¼ */
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","SF Pro Display","Noto Sans KR",sans-serif;
    background:var(--bg-grad) fixed;
    color:#fff;
    padding-top:env(safe-area-inset-top);
    padding-bottom:env(safe-area-inset-bottom);
  }
  .navbar{padding:20px; text-align:center; font-size:26px; font-weight:800;}
  .subtitle{text-align:center; font-size:14px; color:#ffe6f1; margin-bottom:20px;}
  .container{max-width:900px;margin:0 auto; padding:20px;}
  .card{background:rgba(255,255,255,.92); color:#333; border-radius:18px; padding:16px; margin-bottom:16px; box-shadow:0 10px 28px rgba(0,0,0,.08)}
  .field{display:flex; gap:8px; margin-bottom:10px;}
  input, textarea{flex:1; padding:12px; border:none; border-radius:12px; font-size:16px; outline:none; background:#fff}
  textarea{min-height:96px; resize:vertical}
  button{border:none; padding:12px 18px; border-radius:12px; font-weight:700; font-size:15px; cursor:pointer}
  .btn-primary{background:var(--btn-grad); color:#fff;}
  .btn-ghost{background:#ffe6f1; color:#b3124a;}
  .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .progress{margin-top:10px}
  .progress .bar{height:12px; border-radius:999px; background:#ffe6f1; overflow:hidden;}
  .progress .bar>i{display:block; height:100%; background:var(--accent-grad); width:0%; transition:width .25s ease;}
  .sec-title{font-weight:800; margin:6px 0 10px}
  small.hint{color:#666}
</style>
</head>
<body>
  <div class="navbar">ë°˜ì„ì´ë„¤ ê°€ì¡± ì—¬í–‰</div>
  <div class="subtitle">ì˜¤í‚¤ë‚˜ì™€ ğŸ‡¯ğŸ‡µ Â· ë°©ì½• ğŸ‡¹ğŸ‡­ â€” ì…ë ¥ í›„ <b>í™•ì •</b>í•˜ë©´ Firebase DBì— ì €ì¥ë¼ìš”</div>

  <div class="container">
    <!-- ê¸°ë³¸ ì •ë³´ -->
    <div class="card">
      <div class="sec-title">ê¸°ë³¸ ì •ë³´</div>
      <div class="field"><input id="name" placeholder="ì—¬í–‰ì ì´ë¦„ (ì˜ˆ: ìœ ë¹ˆ)"/></div>
      <div class="field"><input id="dates" placeholder="ì—¬í–‰ ë‚ ì§œ (ì˜ˆ: 8ì›”23~30)"/></div>
      <div class="field" style="gap:10px">
        <button id="saveHeader" class="btn-primary">í™•ì¸(ì €ì¥)</button>
        <button id="resetLocal" class="btn-ghost">ë¡œì»¬ ì´ˆê¸°í™”</button>
        <small class="hint" id="saveStatus"></small>
      </div>
      <div class="progress">
        <div class="bar"><i id="overallBar"></i></div>
      </div>
    </div>

    <!-- 1. í™˜ìœ¨ -->
    <div class="card">
      <div class="sec-title">1) í™˜ìœ¨ ê³„ì‚° í€´ì¦ˆ</div>
      <div class="row2">
        <input id="fxJPY" placeholder="10,000ì› â†’ â–  ì—” (JPY)"/>
        <input id="fxTHB" placeholder="10,000ì› â†’ â–  ë°”íŠ¸ (THB)"/>
      </div>
      <div class="field"><input id="fxBonus" placeholder="ë³´ë„ˆìŠ¤: 500ì—” â‰ˆ â–  ë°”íŠ¸"/></div>
      <button class="btn-primary" data-sec="1">í™•ì •(ì €ì¥)</button>
    </div>

    <!-- 2. ì „ê¸° -->
    <div class="card">
      <div class="sec-title">2) ì „ê¸° í”ŒëŸ¬ê·¸ & ì „ì••</div>
      <div class="row2">
        <input id="plugJP" placeholder="ì¼ë³¸: í”ŒëŸ¬ê·¸ íƒ€ì… / ì „ì••"/>
        <input id="plugTH" placeholder="íƒœêµ­: í”ŒëŸ¬ê·¸ íƒ€ì… / ì „ì••"/>
      </div>
      <div class="field"><input id="plugMe" placeholder="ë‚´ ì¶©ì „ê¸° í˜¸í™˜ ì—¬ë¶€(ì˜ˆ: 100â€“240V)"/></div>
      <button class="btn-primary" data-sec="2">í™•ì •(ì €ì¥)</button>
    </div>

    <!-- 3. ë‚ ì”¨ & ì˜·ì°¨ë¦¼ -->
    <div class="card">
      <div class="sec-title">3) ë‚ ì”¨ & ì˜·ì°¨ë¦¼</div>
      <div class="row2">
        <input id="wxOKA" placeholder="ì˜¤í‚¤ë‚˜ì™€: ìµœì €/ìµœê³ /ê°•ìˆ˜"/>
        <input id="wxBKK" placeholder="ë°©ì½•: ìµœì €/ìµœê³ /ê°•ìˆ˜"/>
      </div>
      <div class="field"><textarea id="outfit" placeholder="ì˜·ì°¨ë¦¼/ì•„ì´í…œ (ë°˜íŒ”, ê°€ë””ê±´, ìŠ¬ë¦¬í¼, ìš°ì‚°, ëª¨ì, ì„ í¬ë¦¼ ë“±)"></textarea></div>
      <button class="btn-primary" data-sec="3">í™•ì •(ì €ì¥)</button>
    </div>

    <!-- 4. íšŒí™” -->
    <div class="card">
      <div class="sec-title">4) ê°„ë‹¨ íšŒí™” ì¹´ë“œ</div>
      <div class="field"><textarea id="jpPhrases" placeholder="ì¼ë³¸ì–´ ë©”ëª¨ (ê°ì‚¬í•©ë‹ˆë‹¤ / ì–¼ë§ˆì˜ˆìš”? / ë§›ìˆì–´ìš” + ë°œìŒ)"></textarea></div>
      <div class="field"><textarea id="thPhrases" placeholder="íƒœêµ­ì–´ ë©”ëª¨ (ê°ì‚¬í•©ë‹ˆë‹¤ / ì–¼ë§ˆì˜ˆìš”? / ë§›ìˆì–´ìš” + ë°œìŒ)"></textarea></div>
      <button class="btn-primary" data-sec="4">í™•ì •(ì €ì¥)</button>
    </div>

    <!-- 5. í¸ì˜ì  -->
    <div class="card">
      <div class="sec-title">5) í¸ì˜ì  í•„ìˆ˜í…œ</div>
      <div class="field"><textarea id="cOKA" placeholder="ì˜¤í‚¤ë‚˜ì™€ í¸ì˜ì  ë² ìŠ¤íŠ¸ 3 + ê°€ê²©"></textarea></div>
      <div class="field"><textarea id="cBKK" placeholder="ë°©ì½• í¸ì˜ì  ë² ìŠ¤íŠ¸ 3 + ê°€ê²©"></textarea></div>
      <button class="btn-primary" data-sec="5">í™•ì •(ì €ì¥)</button>
    </div>
  </div>

  <!-- Firebase SDKs (Compat CDN: ê°„ë‹¨íˆ ì‚¬ìš©) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-database-compat.js"></script>

  <script>
    // 1) Firebase ì´ˆê¸°í™” (ì§ˆë¬¸ì—ì„œ ì£¼ì‹  ì„¤ì •)
    const firebaseConfig = {
      apiKey: "AIzaSyBu2rTUwtREkmXicazOXq9D7I6uBQOz87U",
      authDomain: "my-memo-90e91.firebaseapp.com",
      projectId: "my-memo-90e91",
      storageBucket: "my-memo-90e91.firebasestorage.app",
      messagingSenderId: "752429576474",
      appId: "1:752429576474:web:2afc83b95a8af5110c7ca3",
      databaseURL: "https://my-memo-90e91-default-rtdb.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // 2) DOM í—¬í¼
    const $ = id => document.getElementById(id);
    const bar = $('overallBar');
    const statusNote = $('saveStatus');

    // 3) ìµëª… ë¡œê·¸ì¸ í›„ ì‚¬ìš©ì ì „ìš© ê²½ë¡œ ë°˜í™˜
    let uid = null;
    function userPath() {
      if (!uid) return null;
      return db.ref('users/' + uid + '/pretrip');
    }

    // 4) ì§„í–‰ë¥  (ì…ë ¥ ì±„ì›€ ê¸°ì¤€, ì €ì¥ê³¼ ë¬´ê´€ â€” ì‹¤ì‹œê°„ ì‹œê°ë§Œ)
    function updateProgress() {
      const checks = [
        $('name').value && $('dates').value,                                   // header
        $('fxJPY').value && $('fxTHB').value,                                  // sec1
        $('plugJP').value && $('plugTH').value && $('plugMe').value,           // sec2
        $('wxOKA').value && $('wxBKK').value && $('outfit').value,             // sec3
        $('jpPhrases').value && $('thPhrases').value,                          // sec4
        $('cOKA').value && $('cBKK').value                                     // sec5
      ];
      const done = checks.filter(Boolean).length;
      const pct = Math.round(done / checks.length * 100);
      bar.style.width = pct + '%';
    }

    // 5) ì €ì¥ ê³µí†µ í•¨ìˆ˜
    async function saveSection(key, data) {
      if (!userPath()) throw new Error('ë¡œê·¸ì¸ ì „');
      await userPath().child(key).update({ ...data, updatedAt: Date.now() });
      statusNote.textContent = 'ì €ì¥ë¨ âœ“';
      setTimeout(()=> statusNote.textContent = '', 1200);
    }

    // 6) ì„¹ì…˜ í•¸ë“¤ëŸ¬
    function attachSectionSaves() {
      document.querySelectorAll('button[data-sec]').forEach(btn => {
        btn.addEventListener('click', async () => {
          try {
            const sec = Number(btn.dataset.sec);
            if (sec === 1) {
              await saveSection('sec1', {
                fxJPY: $('fxJPY').value.trim(),
                fxTHB: $('fxTHB').value.trim(),
                fxBonus: $('fxBonus').value.trim()
              });
            }
            if (sec === 2) {
              await saveSection('sec2', {
                plugJP: $('plugJP').value.trim(),
                plugTH: $('plugTH').value.trim(),
                plugMe: $('plugMe').value.trim()
              });
            }
            if (sec === 3) {
              await saveSection('sec3', {
                wxOKA: $('wxOKA').value.trim(),
                wxBKK: $('wxBKK').value.trim(),
                outfit: $('outfit').value.trim()
              });
            }
            if (sec === 4) {
              await saveSection('sec4', {
                jpPhrases: $('jpPhrases').value.trim(),
                thPhrases: $('thPhrases').value.trim()
              });
            }
            if (sec === 5) {
              await saveSection('sec5', {
                cOKA: $('cOKA').value.trim(),
                cBKK: $('cBKK').value.trim()
              });
            }
          } catch (e) {
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
          }
        });
      });
    }

    // 7) í—¤ë” ì €ì¥ + ë¡œì»¬ì´ˆê¸°í™”
    $('saveHeader').addEventListener('click', async ()=>{
      try {
        await saveSection('header', {
          name: $('name').value.trim(),
          dates: $('dates').value.trim()
        });
      } catch (e) {
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + (e?.message || e));
      }
    });
    $('resetLocal').addEventListener('click', ()=>{
      if (!confirm('ì…ë ¥ì¹¸ë§Œ ì´ˆê¸°í™”í• ê¹Œìš”? (ì„œë²„ ì €ì¥ ë°ì´í„°ëŠ” ìœ ì§€)')) return;
      document.querySelectorAll('input, textarea').forEach(el=> el.value = '');
      updateProgress();
    });

    // 8) ì…ë ¥ ë³€í™” ì‹œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    document.querySelectorAll('input, textarea').forEach(el=>{
      el.addEventListener('input', updateProgress);
    });

    // 9) DBì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° 1íšŒ)
    function hydrateFromDB(snapshot) {
      const data = snapshot.val() || {};
      // header
      if (data.header?.name) $('name').value = data.header.name;
      if (data.header?.dates) $('dates').value = data.header.dates;
      // sec1
      if (data.sec1?.fxJPY) $('fxJPY').value = data.sec1.fxJPY;
      if (data.sec1?.fxTHB) $('fxTHB').value = data.sec1.fxTHB;
      if (data.sec1?.fxBonus) $('fxBonus').value = data.sec1.fxBonus;
      // sec2
      if (data.sec2?.plugJP) $('plugJP').value = data.sec2.plugJP;
      if (data.sec2?.plugTH) $('plugTH').value = data.sec2.plugTH;
      if (data.sec2?.plugMe) $('plugMe').value = data.sec2.plugMe;
      // sec3
      if (data.sec3?.wxOKA) $('wxOKA').value = data.sec3.wxOKA;
      if (data.sec3?.wxBKK) $('wxBKK').value = data.sec3.wxBKK;
      if (data.sec3?.outfit) $('outfit').value = data.sec3.outfit;
      // sec4
      if (data.sec4?.jpPhrases) $('jpPhrases').value = data.sec4.jpPhrases;
      if (data.sec4?.thPhrases) $('thPhrases').value = data.sec4.thPhrases;
      // sec5
      if (data.sec5?.cOKA) $('cOKA').value = data.sec5.cOKA;
      if (data.sec5?.cBKK) $('cBKK').value = data.sec5.cBKK;

      updateProgress();
    }

    // 10) ì‹œì‘: ìµëª… ë¡œê·¸ì¸ â†’ ë°ì´í„° ë¡œë“œ â†’ ì´ë²¤íŠ¸ ë¶€ì°©
    (async function start(){
      try{
        const cred = await auth.signInAnonymously();
        uid = cred.user.uid;
        // ì´ˆê¸° ë¡œë“œ
        const ref = userPath();
        const snap = await ref.get();
        hydrateFromDB(snap);
        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸(ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œë„ ê°™ì€ ê³„ì •ì´ë©´ ë°˜ì˜)
        ref.on('value', hydrateFromDB);
        // ë²„íŠ¼ë“¤ í™œì„±í™”
        attachSectionSaves();
      }catch(e){
        alert('ë¡œê·¸ì¸/ì´ˆê¸°í™” ì˜¤ë¥˜: ' + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
